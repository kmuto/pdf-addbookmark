= PDFに外部目次ファイルからしおり(ブックマーク)を埋め込むツール

Copyright 2012 Kenshi Muto <kmuto@debian.org>

既存のPDFに対してしおりを埋め込むには、通常、AcrobatのようなGUIソフトウェア
を利用して1つずつ手で設定していくことになりますが、数が多いとうんざりする作業
になります。

本ツールは、別途抽出した目次テキストファイルなどを少し加工したものを使い、
しおり情報をPDFに一度に埋め込むためのものです。

== 必要なソフトウェア
* Ruby 1.9以上 (内部で使用している命令上、1.8では動作しません)
* Ghostscript (埋め込み生成まで行う場合。このツールではforkを利用して起動するため、Windowsでは動作しません)

Debian GNU/Linux 7.0 Wheezyで動作確認をしています。

== 使い方
しおり用の目次ファイルを作成し、pdf-addbookmark.rbに渡すと、しおりの
PostScriptファイルが標準出力に出力されます。GhostscriptまたはAdobe
Distillerを使って目的のPDFに合体させれば、しおりが埋め込まれます。

pdf-addbookmark.rbの-iオプションと-oオプションを使い、入出力PDFも指定す
ると、Ghostscriptの利用できる環境であれば、PDFの出力まで一括して行えま
す。

埋め込み対象のPDFは、大扉から白ページまですべて込みの完全な状態であるこ
とを想定しています。

書籍によっては、大扉ノンブルをアラビア数字の1とするいわゆる「通しページ」
ではなく、1章が始まるまではローマ数字1(i)で始めて1章からアラビア数字の
1とするものもあります。この場合、アラビア数字1が始まるまで(いわゆる前
付)のページ総数を、-fオプションで指定します。

  $ pdf-addbookmark.rb -f 28 toc.txt
  [/Title (\376\377\212\63\200\5\60\176\60\110\60\114\60\115) /Page 5 /OUT pdfmark
  [/Title (\376\377\60\157\60\130\60\201\60\153) /Page 7 /OUT pdfmark
  [/Title (\376\377\0\61\172\340\60\0\0\120\0\145\0\162\0\154\121\145\225\200) /Count 12 /Page 1 /OUT pdfmark
  [/Title (\376\377\0\61\0\56\0\61\60\0\214\352\165\221\137\334\173\124) /Count 5 /Page 1 /OUT pdfmark
  …

  $ pdf-addbookmark.rb -f 28 -i lrn-perl6.pdf -o lrn-perl6-with-bookmark.pdf toc.txt
  (lrn-perl6-with-bookmark.pdfが作成される)

=== しおり用の目次ファイル
* UTF-8エンコーディング、UNIX改行形式(LF)で記述してください。
* 先頭のタブの数で見出しの深さを指定します。この深さに基づいて、しおりの階層構造ができあがります。
* 見出しとノンブルは、タブで区切ります。
* #から始まる行はコメントです。オプションで指定するようないくつかの命令を事前構成することもできます(オプションよりもこちらが優先されます)。(FOREWORDPAGES:前付ページ、SPLITTER:区切り文字、HIDELEVEL:最初は閉じておくレベル)

例を次に示します。

  # 『初めてのPerl 第6版』(オライリー・ジャパン) より。
  # 前付部は28ページ分。
  訳者まえがき	v
  はじめに	vii
  1章　Perl入門	1
  	1.1　質疑応答	1
  		1.1.1　この本はわたしに向いていますか?	1
  		1.1.2　なぜこんなにたくさんの脚注が付いているのでしょうか?	2
  		1.1.3　練習問題と解答について教えてください	3
  		1.1.4　練習問題の先頭の数字は何を意味するのでしょうか?	4
  		1.1.5　私はPerlコースの講師ですが、アドバイスをいただけますか?	4
  	1.2　Perlとは何の略でしょうか?	5
  		1.2.1　なぜLarryはPerlを創ったのでしょうか?	5
  		1.2.2　なぜLarryはほかの言語を使わなかったのでしょうか?	5
  		1.2.3　Perlは易しいでしょうか難しいでしょうか?	6
  		1.2.4　Perlはどのようにしてこんなに人気を得るようになったのですか?	8
  		1.2.5　いまPerlに何が起こっているのでしょうか?	9
  2章　スカラーデータ	25
  	2.1　数値	25

== オプション
pdf-addbookmark.rbには、いくつかのオプションを指定できます。

* -h または --help: ヘルプを表示します。
* -f <オフセット数> または --forewordpages=<オフセット数>: 大扉からの通しページではない(ローマ数字の前付がある)場合に、アラビア数字のノンブル1ページが始まるまでの前付ページ総数を指定します。ローマ数字の前付がある場合には、これを指定しないとしおりの飛び先が狂ってしまいます。デフォルトは0です。
* -s '<区切り文字>' または --splitter='<区切り文字>': 目次の見出しにタブが含まれている場合は、指定の区切り文字に変換します。デフォルトでは全角スペースです。
* -l <見出しレベル> または --hidelevel=<見出しレベル>: この階層よりも深い見出しについては、最初は閉じた状態のしおりとします。デフォルトは2です。
* -g '<Ghostscript起動設定>' または --gs='<Ghostscript起動設定>': -i/-oオプションが指定されていてGhostscriptを起動する必要がある場合、その呼び出しパラメータを設定します。デフォルトは「gs -q -dBATCH -dNOPAUSE -sDEVICE=pdfwrite -sOutputFile=<<%outpdf%>> <<%bookmark%>> <<%inpdf%>>」です。<<>>内のパラメータは呼び出し前に妥当なものに置換されます。
* -i <埋め込み元PDF> または --input=<埋め込み元PDF>: しおりを埋め込む元となるPDFです。-oオプションと共に使います。
* -o <出力PDF> または --output=<出力PDF>: しおりを埋め込んだPDFです。-iオプションと共に使います。既存のファイルがあっても確認せずに上書きするので注意してください。

== 謝辞
本ツール作成にあたっては、@turky (Akihiro Takizawa)さんからベースとなる
Pythonコードのほか、多数の有益な情報をいただきました。ここに感謝いたします。
